# IoT Support Firmware Upload Script (PowerShell)
# Generated by {{ backend_url }}/api/pipeline/upload.ps1
#
# Usage: irm {{ backend_url }}/api/pipeline/upload.ps1 | iex; Upload-Firmware [model_code] [firmware.bin]
#
# Arguments are optional - if omitted, they are inferred from build/project_description.json
#
# Environment variables:
#   IOTSUPPORT_CLIENT_ID     - OAuth2 client ID with pipeline role (required)
#   IOTSUPPORT_CLIENT_SECRET - OAuth2 client secret (required)

$ErrorActionPreference = "Stop"

function Upload-Firmware {
    param(
        [Parameter(Position = 0)][string]$ModelCode,
        [Parameter(Position = 1)][string]$FirmwareFile
    )

    # Baked-in configuration from server
    $BackendUrl = "{{ backend_url }}"
    $TokenUrl = "{{ token_url }}"

    # Auto-detect from ESP-IDF project description if arguments not provided
    $ProjectDesc = "build/project_description.json"
    if (-not $ModelCode -or -not $FirmwareFile) {
        if (-not (Test-Path $ProjectDesc)) {
            throw "No arguments provided and $ProjectDesc not found. Run from ESP-IDF project root, or provide arguments explicitly."
        }

        $ProjectInfo = Get-Content $ProjectDesc | ConvertFrom-Json
        $ProjectName = $ProjectInfo.project_name

        if (-not $ProjectName) {
            throw "Could not extract project_name from $ProjectDesc"
        }

        # Use extracted values if not provided as arguments
        if (-not $ModelCode) { $ModelCode = $ProjectName }
        if (-not $FirmwareFile) { $FirmwareFile = "build/$ProjectName.bin" }

        Write-Host "Auto-detected from ${ProjectDesc}: model=$ModelCode, file=$FirmwareFile"
    }

    # Validate file exists
    if (-not (Test-Path $FirmwareFile)) {
        throw "Firmware file not found: $FirmwareFile"
    }

    # Validate environment variables
    if (-not $env:IOTSUPPORT_CLIENT_ID) {
        throw "IOTSUPPORT_CLIENT_ID environment variable is required"
    }
    if (-not $env:IOTSUPPORT_CLIENT_SECRET) {
        throw "IOTSUPPORT_CLIENT_SECRET environment variable is required"
    }
    if (-not $TokenUrl) {
        throw "Server did not provide token URL (OIDC not configured)"
    }

    # Get OAuth2 token
    Write-Host "Authenticating with $TokenUrl..."
    $tokenResponse = Invoke-RestMethod -Uri $TokenUrl -Method Post -Body @{
        grant_type    = "client_credentials"
        client_id     = $env:IOTSUPPORT_CLIENT_ID
        client_secret = $env:IOTSUPPORT_CLIENT_SECRET
    }
    $accessToken = $tokenResponse.access_token

    if (-not $accessToken) {
        throw "Failed to obtain access token"
    }

    # Derive paths for companion build artifacts
    $BuildDir = Split-Path $FirmwareFile -Parent
    $BinBasename = [System.IO.Path]::GetFileNameWithoutExtension($FirmwareFile)
    $ElfFile = Join-Path $BuildDir "$BinBasename.elf"
    $MapFile = Join-Path $BuildDir "$BinBasename.map"
    $SdkConfigFile = "sdkconfig"

    # Verify all ZIP artifacts are present
    $missingFiles = @()
    foreach ($f in @($ElfFile, $MapFile, $SdkConfigFile)) {
        if (-not (Test-Path $f)) { $missingFiles += $f }
    }
    if ($missingFiles.Count -gt 0) {
        throw "Missing required build artifacts: $($missingFiles -join ', '). Ensure the project has been built and all artifacts (.elf, .map, sdkconfig) are present."
    }

    $uploadUrl = "$BackendUrl/api/pipeline/models/$ModelCode/firmware"

    # Package as ZIP with all build artifacts
    Write-Host "Packaging firmware ZIP for model $ModelCode..."

    # Extract build metadata from project_description.json
    $projInfo = Get-Content $ProjectDesc | ConvertFrom-Json
    $fwVersion = if ($projInfo.project_version) { $projInfo.project_version } else { "unknown" }
    $idfVersion = if ($projInfo.git_revision) { $projInfo.git_revision } else { "unknown" }

    # Get git commit hash
    try { $gitCommit = (git rev-parse HEAD 2>$null) } catch { $gitCommit = "unknown" }
    if (-not $gitCommit) { $gitCommit = "unknown" }

    # Generate version.json
    $tempDir = Join-Path ([System.IO.Path]::GetTempPath()) ([System.IO.Path]::GetRandomFileName())
    New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

    try {
        $versionJson = @{
            git_commit       = $gitCommit
            idf_version      = $idfVersion
            firmware_version = $fwVersion
        } | ConvertTo-Json -Compress

        $versionJsonPath = Join-Path $tempDir "version.json"
        Set-Content -Path $versionJsonPath -Value $versionJson -Encoding UTF8

        # Create ZIP with required files
        $zipPath = Join-Path $tempDir "firmware.zip"
        Compress-Archive -Path $FirmwareFile, $ElfFile, $MapFile, $SdkConfigFile, $versionJsonPath -DestinationPath $zipPath -Force

        Write-Host "Uploading firmware ZIP to model $ModelCode..."
        $fileBytes = [System.IO.File]::ReadAllBytes($zipPath)
        $response = Invoke-RestMethod -Uri $uploadUrl -Method Post `
            -Headers @{ Authorization = "Bearer $accessToken" } `
            -ContentType "application/octet-stream" `
            -Body $fileBytes
    }
    finally {
        Remove-Item -Recurse -Force $tempDir -ErrorAction SilentlyContinue
    }

    if ($response.firmware_version) {
        Write-Host "Success: Uploaded firmware version $($response.firmware_version)"
    } else {
        Write-Host "Success: Firmware uploaded"
        Write-Host "Response: $($response | ConvertTo-Json -Compress)"
    }
}
