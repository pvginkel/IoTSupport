# IoT Support Firmware Upload Script (PowerShell)
# Generated by {{ backend_url }}/api/pipeline/upload.ps1
#
# Usage: irm {{ backend_url }}/api/pipeline/upload.ps1 | iex; Upload-Firmware [model_code] [firmware.bin]
#
# Arguments are optional - if omitted, they are inferred from build/project_description.json
#
# Environment variables:
#   IOTSUPPORT_CLIENT_ID     - OAuth2 client ID with pipeline role (required)
#   IOTSUPPORT_CLIENT_SECRET - OAuth2 client secret (required)

$ErrorActionPreference = "Stop"

function Upload-Firmware {
    param(
        [Parameter(Position = 0)][string]$ModelCode,
        [Parameter(Position = 1)][string]$FirmwareFile
    )

    # Baked-in configuration from server
    $BackendUrl = "{{ backend_url }}"
    $TokenUrl = "{{ token_url }}"

    # Auto-detect from ESP-IDF project description if arguments not provided
    $ProjectDesc = "build/project_description.json"
    if (-not $ModelCode -or -not $FirmwareFile) {
        if (-not (Test-Path $ProjectDesc)) {
            throw "No arguments provided and $ProjectDesc not found. Run from ESP-IDF project root, or provide arguments explicitly."
        }

        $ProjectInfo = Get-Content $ProjectDesc | ConvertFrom-Json
        $ProjectName = $ProjectInfo.project_name

        if (-not $ProjectName) {
            throw "Could not extract project_name from $ProjectDesc"
        }

        # Use extracted values if not provided as arguments
        if (-not $ModelCode) { $ModelCode = $ProjectName }
        if (-not $FirmwareFile) { $FirmwareFile = "build/$ProjectName.bin" }

        Write-Host "Auto-detected from ${ProjectDesc}: model=$ModelCode, file=$FirmwareFile"
    }

    # Validate file exists
    if (-not (Test-Path $FirmwareFile)) {
        throw "Firmware file not found: $FirmwareFile"
    }

    # Validate environment variables
    if (-not $env:IOTSUPPORT_CLIENT_ID) {
        throw "IOTSUPPORT_CLIENT_ID environment variable is required"
    }
    if (-not $env:IOTSUPPORT_CLIENT_SECRET) {
        throw "IOTSUPPORT_CLIENT_SECRET environment variable is required"
    }
    if (-not $TokenUrl) {
        throw "Server did not provide token URL (OIDC not configured)"
    }

    # Get OAuth2 token
    Write-Host "Authenticating with $TokenUrl..."
    $tokenResponse = Invoke-RestMethod -Uri $TokenUrl -Method Post -Body @{
        grant_type    = "client_credentials"
        client_id     = $env:IOTSUPPORT_CLIENT_ID
        client_secret = $env:IOTSUPPORT_CLIENT_SECRET
    }
    $accessToken = $tokenResponse.access_token

    if (-not $accessToken) {
        throw "Failed to obtain access token"
    }

    # Upload firmware
    Write-Host "Uploading $(Split-Path $FirmwareFile -Leaf) to model $ModelCode..."
    $uploadUrl = "$BackendUrl/api/pipeline/models/$ModelCode/firmware"

    # Read file as bytes and upload
    $fileBytes = [System.IO.File]::ReadAllBytes((Resolve-Path $FirmwareFile))
    $response = Invoke-RestMethod -Uri $uploadUrl -Method Post `
        -Headers @{ Authorization = "Bearer $accessToken" } `
        -ContentType "application/octet-stream" `
        -Body $fileBytes

    if ($response.firmware_version) {
        Write-Host "Success: Uploaded firmware version $($response.firmware_version)"
    } else {
        Write-Host "Success: Firmware uploaded"
        Write-Host "Response: $($response | ConvertTo-Json -Compress)"
    }
}
