# Change Brief: Coredump Upload & Firmware ZIP Support

## Summary

Add two related capabilities: (1) a device-facing endpoint for ESP32 coredump uploads with filesystem storage, and (2) extend the firmware upload pipeline to accept ZIP bundles containing ELF/MAP/sdkconfig files alongside the .bin, enabling future coredump analysis by preserving historical firmware artifacts.

## Coredump Upload

Add a new `POST /iot/coredump` endpoint that accepts a raw binary coredump in the request body. The device provides `chip` and `firmware_version` as required query string parameters.

- New environment variable `COREDUMPS_DIR` controls the storage location.
- Coredumps are stored in per-device directories: `COREDUMPS_DIR/{device_key}/coredump_YYYYMMDDTHHMMSSZ.dmp`
- A JSON sidecar file (`.json` extension, same base name) stores metadata: chip, firmware_version, device_key, model_code, uploaded_at.
- 1MB maximum upload size.
- No database model — filesystem only.
- No coredump parsing or analysis — that is a later phase.

## Firmware ZIP Upload

Extend the existing firmware upload pipeline endpoint to accept ZIP files in addition to raw .bin files.

- A valid ZIP must contain exactly: `{model_code}.bin`, `{model_code}.elf`, `{model_code}.map`, `sdkconfig`, `version.json`. Reject the upload if the ZIP violates this structure.
- `version.json` contains build metadata: `git_commit` (from `git rev-parse HEAD`), `idf_version` (from `idf.py --version`), and `firmware_version` (from `build/project_description.json`). Generated by the upload scripts before packaging.
- Extract the firmware version from the `.bin` file inside the ZIP (existing ESP32 AppInfo parsing).
- Store the ZIP as `ASSETS_DIR/{model_code}/firmware-{version}.zip` — this preserves historical firmware versions.
- Continue supporting plain `.bin` uploads for backward compatibility.
- When a device requests firmware: if a versioned ZIP exists for the model's current firmware version, extract and serve the `.bin` from it; otherwise fall back to the legacy loose `.bin` file.
- Update the pipeline upload scripts (sh and ps1 templates) to package the build artifacts into a ZIP and upload it.

## Motivation

The firmware version recorded in the coredump sidecar JSON links the coredump to the versioned ZIP, which contains the ELF binary needed for stack trace analysis. This change establishes the storage foundation; coredump analysis will be built in a subsequent phase.
